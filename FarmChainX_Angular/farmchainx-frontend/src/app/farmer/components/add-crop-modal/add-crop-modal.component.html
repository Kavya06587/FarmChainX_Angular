<div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">

    <div class="flex justify-between items-center mb-5">
      <h2 class="text-xl font-semibold">Add New Crop</h2>
      <button (click)="closeModal()">✕</button>
    </div>

    <!-- SUCCESS -->
    <div *ngIf="success" class="space-y-4 text-center">
      <div class="bg-green-50 border border-green-200 rounded-xl p-4">
        <h3 class="font-semibold text-green-800">Crop Added Successfully</h3>
        <p class="text-sm text-green-700 mt-1">Batch ID</p>
        <p class="font-mono font-bold">{{ generatedBatchId }}</p>
      </div>

      <div *ngIf="qrValue">
        <img
          class="mx-auto"
          [src]="'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + qrValue" />
        <p class="text-xs break-all mt-2">{{ qrValue }}</p>
      </div>

      <div class="flex gap-3">
        <button class="btn-secondary flex-1" (click)="reset()">Add Another</button>
        <button class="btn-primary flex-1" (click)="closeModal()">Done</button>
      </div>
    </div>

    <!-- FORM -->
    <div *ngIf="!success">

      <div *ngIf="error" class="mb-3 p-3 bg-red-50 text-red-700 rounded text-sm">
        {{ error }}
      </div>

      <div class="space-y-3">

        <input class="w-full border p-2 rounded"
               placeholder="Crop Name"
               [(ngModel)]="form.cropName" />

        <select class="w-full border p-2 rounded"
                [(ngModel)]="form.cropType">
          <option value="">Select Crop Type</option>
          <option *ngFor="let c of cropTypes" [value]="c">{{ c }}</option>
        </select>

        <input type="date" class="w-full border p-2 rounded"
               [(ngModel)]="form.sowDate" />

        <input type="date" class="w-full border p-2 rounded"
               [(ngModel)]="form.expectedHarvestDate" />

        <input class="w-full border p-2 rounded"
               placeholder="Location"
               [(ngModel)]="form.location" />

        <input class="w-full border p-2 rounded"
               type="number"
               placeholder="Estimated Yield"
               [(ngModel)]="form.estimatedYield" />

        <!-- IMAGE -->
        <input type="file" accept="image/*" (change)="onFileChange($event)" />

        <div *ngIf="previewUrl" class="mt-2">
          <img [src]="previewUrl" class="w-full h-40 object-cover rounded" />
        </div>

        <!-- PRICE / QTY -->
        <div class="grid grid-cols-2 gap-3">
          <input type="number"
                 class="border p-2 rounded"
                 placeholder="Price (₹)"
                 [(ngModel)]="form.price" />

          <input type="number"
                 class="border p-2 rounded"
                 placeholder="Quantity (kg)"
                 [(ngModel)]="form.quantity" />
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <button class="btn-secondary flex-1" (click)="closeModal()">Cancel</button>
        <button class="btn-primary flex-1" [disabled]="loading" (click)="submit()">
          {{ loading ? 'Adding...' : 'Add Crop' }}
        </button>
      </div>
    </div>

  </div>
</div>
